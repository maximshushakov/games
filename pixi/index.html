<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/v6.5.8/pixi.js"></script>
    <script module src="https://cdn.jsdelivr.net/npm/pixi-filters@latest/dist/pixi-filters.js"></script>

    <style>
      html, body {
        margin: 0; padding: 0;
      }
      canvas {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <script>
      // import {CRTFilter} from '@pixi/filter-crt';
      // Create the application helper and add its render target to the page
      let app = new PIXI.Application({ width: 640, height: 360 });
      app.renderer.backgroundColor = "0x02020F";
      document.body.appendChild(app.view);


      // Create the sprite and add it to the stage
      
      let sprite = PIXI.Sprite.from('sample.png');
      let position = 320.0;
      sprite.y = 260.0;

      sprite.anchor.set(0.5);
      sprite.scale.set(0.5);

      // Create a master graphics object
      let template = new PIXI.Graphics();
      // Add a circle
      template.beginFill(0xFFFFFF);
      template.drawCircle(0, 0, 1);
      template.endFill();

      const stars = [];
      const speeds = [];
      for(var i = 0; i < 100; i++) {
        var s = new PIXI.Graphics(template.geometry);
        s.x = Math.random() * app.renderer.width;
        s.y = Math.random() * app.renderer.height;
        s.alpha = Math.random();
        s.scale.set(Math.random() * 2);
        stars.push(s);
        app.stage.addChild(s);
        speeds[i] = 0.3 + Math.random();
      }
      
      app.stage.addChild(sprite);

      const atlasData = {
        frames: {
          fire1: {
            frame: { x: 0, y:0, w:200, h:220 },
            sourceSize: { w: 200, h: 220 },
            spriteSourceSize: { x: 0, y: 0, w: 200, h: 220 }
          },
          fire2: {
            frame: { x: 180, y:0, w:220, h:220 },
            sourceSize: { w: 200, h: 220 },
            spriteSourceSize: { x: 0, y: 0, w: 200, h: 220 }
          },
          fire3: {
            frame: { x: 380, y:0, w:220, h:220 },
            sourceSize: { w: 200, h: 220 },
            spriteSourceSize: { x: 0, y: 0, w: 200, h: 220 }
          },
        },
        meta: {
          image: 'fire.avif',
          format: 'RGBA8888',
          size: { w: 932, h: 740 },
          scale: 1
        },
        animations: {
          fire: ['fire1','fire2','fire3'] //array of frames by name
        }
      }

      const spritesheet = new PIXI.Spritesheet(
        PIXI.BaseTexture.from(atlasData.meta.image),
        atlasData
      );

      spritesheet.parse();
      // spritesheet is ready to use!
      const anim = new PIXI.AnimatedSprite(spritesheet.animations.fire);
      anim.scale.set(.2);
      anim.y = 325;
      anim.rotation = Math.PI / 2;
      anim.anchor.set(0.5);
      // set the animation speed 
      anim.animationSpeed = 0.1666;
      // play the animation on a loop
      anim.play();
      // add it to the stage to render
      app.stage.addChild(anim);
      
      const filter = new PIXI.filters.CRTFilter();
      // filter.verticalLine = true;
      filter.lineWidth = 0.1;
      filter.noise = 0.3;
      filter.noiseSize = 0.1;
      app.stage.filters = [filter];

      // Add a ticker callback to move the sprite back and forth
      let elapsed = 0.0;
      app.ticker.add((delta) => {
        elapsed += delta;
        // sprite.x = 320.0 + Math.cos(elapsed/50.0) * 5.0;
        // anim.x = 322.0 + Math.cos(elapsed/50.0) * 10.0;
        // sprite.y = 200.0 + Math.cos(elapsed/50.0) * 5.0;
        filter.seed = Math.random();
        // filter.time += 0.1;
        for (var i = 0; i < 100; ++i) {
          var s = stars[i];
          s.y += speeds[i];
          if (s.y > app.renderer.height) s.y = 0;
        }

        const mouse = app.renderer.plugins.interaction.mouse.global;
        position += (mouse.x - position) / 20;
        if (position < 0) position = 0;
        if (position > 640) position = 640;
        sprite.x = position + Math.cos(elapsed/50.0) * 10.0;
        anim.x = sprite.x + 2;
      });
    </script>
  </body>
</html>